name: Build LockedinOS Packages

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [created]

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: packages/tasks-calendar/package-lock.json

      - name: Install dependencies
        working-directory: packages/tasks-calendar
        run: npm ci

      - name: Lint
        working-directory: packages/tasks-calendar
        run: npm run lint || true

      - name: Test
        working-directory: packages/tasks-calendar
        run: npm test || true

      - name: Build renderer
        working-directory: packages/tasks-calendar
        run: npm run build:renderer

      - name: Validate focus-mode script
        run: |
          bash -n packages/lockedin-focus/scripts/lockedin-focus
          echo "Focus mode script syntax OK"

      - name: Validate build scripts
        run: |
          bash -n infra/prepare-chroot.sh
          bash -n infra/build-iso.sh
          bash -n infra/build-live-build.sh
          bash -n configs/gnome/apply-gsettings.sh
          bash -n configs/gnome/remove-social-apps.sh
          bash -n configs/installer/first-boot-wizard.sh
          echo "All scripts syntax OK"

  build-tasks-calendar-deb:
    name: Build Tasks & Calendar .deb
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot dpkg-dev

      - name: Build .deb package
        working-directory: packages/tasks-calendar
        run: |
          chmod +x build-deb.sh
          ./build-deb.sh

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: lockedin-tasks-calendar-deb
          path: packages/tasks-calendar/build/*.deb

  build-focus-deb:
    name: Build Focus Mode .deb
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get install -y fakeroot dpkg-dev

      - name: Build .deb package
        working-directory: packages/lockedin-focus
        run: |
          chmod +x build-deb.sh
          ./build-deb.sh

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: lockedin-focus-deb
          path: packages/lockedin-focus/build/*.deb

  build-iso:
    name: Build ISO (self-hosted)
    runs-on: self-hosted
    needs: [build-tasks-calendar-deb, build-focus-deb]
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v4

      - name: Download .deb artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare packages directory
        run: |
          mkdir -p packages/tasks-calendar/build
          mkdir -p packages/lockedin-focus/build
          cp artifacts/lockedin-tasks-calendar-deb/*.deb packages/tasks-calendar/build/ || true
          cp artifacts/lockedin-focus-deb/*.deb packages/lockedin-focus/build/ || true

      - name: Download Ubuntu ISO
        run: |
          if [ ! -f /tmp/ubuntu-24.04-desktop-amd64.iso ]; then
            wget -q https://releases.ubuntu.com/24.04/ubuntu-24.04-desktop-amd64.iso \
              -O /tmp/ubuntu-24.04-desktop-amd64.iso
          fi

      - name: Build ISO
        run: |
          chmod +x infra/build-iso.sh
          sudo ./infra/build-iso.sh /tmp/ubuntu-24.04-desktop-amd64.iso release/

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: lockedinos-iso
          path: |
            release/*.iso
            release/*.sha256
            release/*-manifest.txt

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.iso
            release/*.sha256
            release/*-manifest.txt
